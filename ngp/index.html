<!DOCTYPE html>
<html lang="en">
<head>

  <!-- Basic Page Needs
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta charset="utf-8">
  <title>NGP Contacts Normalizer</title>

  <!-- Mobile Specific Metas
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <!-- FONT
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link href="https://fonts.googleapis.com/css?family=Raleway:400,300,600" rel="stylesheet" type="text/css">

  <!-- CSS
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <link rel="stylesheet" href="css/normalize.css">
  <link rel="stylesheet" href="css/skeleton.css">

  <!-- Favicon
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <!-- <link rel="icon" type="image/png" href="images/favicon.png"> -->

  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.7.0/d3.min.js"></script>

  <style>
    .container { max-width: 1180px; }
    p, .row { margin-bottom: 1rem; }
    button, .button { min-width: 200px; }
    input[type=radio] { margin-bottom: 0px; }
    .mono { font-family: "Lucida Console", Monaco, monospace; color: #777; }
  </style>
</head>
<body>

  <!-- Primary Page Layout
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
  <div style="background-color: #333;">
    <div class="container" style="margin-bottom: 1rem;">
      <div class="row">
        <div class="twelve columns">
          <h4 style="margin: 1rem 0; font-weight: bold; color: #FF8C00;">NGP Contacts Normalizer</h4>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <div class="row">
      <div class="seven columns">
        <label>Instructions</label>

        <p>NGP export CSVs may contain multiple email addresses per row/contact. ActionKit import CSVs must contain one email address per row. This widget takes an NGP export CSV and transforms it into a format accepted by ActionKit.</p>

        <p>This widget may be used to a) target a finance-led email, or b) match all NGP contacts with ActionKit users & import NGP contact codes (uber/mega/bfd/sustainer tags):</p>

        <p style="margin-left: 24px;">a) If targeting a finance-led email, export an NGP contacts report including columns for <span class="mono">Contact ID</span>, <span class="mono">fle_email_household_salutation</span>, <span class="mono">Salutation</span>, and <span class="mono">First Name</span>, and any email columns you wish to target the FLE to (e.g. <span class="mono">Primary Email</span>, <span class="mono">Home Email</span>, etc.). To include arbitrary data, append the <span class="mono">extra_1</span>, <span class="mono">extra_2</span>, and/or <span class="mono">extra_3</span> columns.</p>

        <p style="margin-left: 24px;">b) If matching all contacts, export an NGP contacts report including columns for <span class="mono">Contact ID</span>, <span class="mono">Contact Code Ids</span> and any email columns you wish to match on (e.g. <span class="mono">Primary Email</span>, <span class="mono">Home Email</span>, etc.), and select the "full export" option.</p>
        
        <hr/>

        <ol>
        <li>Use this widget to transform an NGP export CSV into an ActionKit import CSV.</li>

        <li>Log into ActionKit and navigate to the dedicated NGP Contact ID Importer page: <a href="https://act.democracyforamerica.com/admin/core/importpage/9666" target="_blank">https://act.democracyforamerica.com/admin/core/importpage/9666</a></li>

        <li>Set a unique default action source using the following format: <span class="mono">ngp.[campaign/subject].[YYYYMMDD]</span>, e.g. <span class="mono">ngp.purple-to-blue.20190801</span> - use only letters, numbers, period, hyphens & underscores (no spaces). <strong>If targeting a finance-led email, select the "Subscribe to list" subscription option. Otherwise, select "Don't change subscriptions."</strong><br/><br/><img src="img/import_options.png" style="max-width: 100%;"></li>

        <li>Click the "Next: Upload file" button.</li>

        <li>On the next page, check the "Terms and Conditions" checkbox, select the normalized CSV file generated by the widget, and click the "Start Upload" button. <strong>If running a full contact match, stop here. If targeting a finance-led email, complete the remaining steps.</strong></li>

        <li>Once the upload has completed, navigate to the finance-led email you wish to target. On the "Compose" tab, select the "FLE targeting" merge query, and paste the source code from the importer page.<br/><br/><img src="img/compose.png" style="max-width: 100%;"></li>

        <li>On the "Targeting" tab, select "Query Library" from the targeting criteria options, and add the "Safe FLE targeting query" with the source code from the importer page. Lastly, check the "Only include users matching the values in the user_id column from this mergequery" checkbox. The targeting options should look like this, when complete:<br/><br/><img src="img/target.png" style="max-width: 100%;"></li>
        </ol>

        <label>Mailing Composition</label>

        <p>When composing a finance-led email, use the following snippet (or similar) to include a salutation:</p>

        <p><span class="mono">Hi{% if user.custom_fields.fle_salutation %} {{ user.custom_fields.fle_salutation }}{% elif user.first_name %} {{ user.first_name }}{% endif %},</span></p>

        <p>Use the <span class="mono">{{ query.extra_1 }}</span>, <span class="mono">{{ query.extra_1 }}</span>, <span class="mono">{{ query.extra_2 }}</span>, and <span class="mono">{{ query.extra_3 }}</span> snippets to include custom fields. To format a dollar amount, use the <span class="mono">floatformat</span> filter: <span class="mono">${{ query.extra_1|floatformat:-2 }}</span></p>
      </div>

      <div class="five columns">
        <div class="row">
          <label>Select an NGP export CSV</label>
          <button onclick="document.querySelector('input[name=csv]').click()" class="button-primary">Select CSV</button>
          <span id="csvFilename">No file chosen</span>
          <input type="file" name="csv" onchange="d3.select('#settings').style('display', 'block'); d3.select('#csvFilename').text(document.querySelector('input[name=csv]').files[0].name);" style="display: none;" />
        </div>

        <div id="settings" class="row" style="display: none;">
          <label>Is this a full export of all NGP contacts?</label>
          <label><input type="radio" name="full_export" value="t" onchange="d3.select('#load').style('display', 'block');" /> Yes</label>
          <label><input type="radio" name="full_export" value="f" onchange="d3.select('#load').style('display', 'block');" /> No</label>
        </div>

        <div id="load" class="row" style="display: none;">
          <label>Click to process contacts</label>
          <button onclick="loadCsv()" class="button-primary">Process Contacts</button>
        </div>

        <div id="downloadDiv" class="row" style="display: none;">
          <label>Click to download results</label>
          <div><a id="downloadLink" href="#" class="button button-primary">Download results</a></div>
        </div>
      </div>
    </div>

  </div>

  <script>
    window.csvReader = new FileReader();

    var loadCsv = function() {
      var file = document.querySelector('input[name=csv]').files[0];
      csvReader.addEventListener("load", parseCsv, false);
      if (file) {
        csvReader.readAsText(file);
      }
    }

    var parseCsv = function() {
      window.fullExport = d3.select('input[name="full_export"]:checked').property('value') == 't' ? true : false;

      window.records = d3.csvParse(csvReader.result, function(d) {
        return d;
      });

      window.ngpContactCodes = {
         "95762": "mega",
         "97648": "uber",
         "97659": "bfd",
        "107774": "sustainer"
      }

      window.ignoredEmails = ['','compliance@democracyforamerica.com','finance@democracyforamerica.com','none@none.com','sharegroup@synetechllc.com','noreply@noreply.com','no@noreply.com','tm@aol.com','nomail@xxx.com','comliance@democracyforamerica.com','richardsa@dnc.org','sdutta@barackobama.com','actionfund@ppfa.org','pacbod@fsround.org','uapif@uanet.org','fanniemae_pac@fanniemae.com','info@21stdems.org','leg@narfe.org','political@nfib.org','salliemae.pac@salliemae.com','pac@citi.com','richardsa@dnc.com','noaddress@noaddress.org']

      window.headers = ["email"];

      if (fullExport) {
        headers.push("user_ngp_ids_with_this_email");
      }

      if ( records.columns.includes("Contact Code Ids") ) {
        headers.push("user_ngp_contact_codes");
      }

      for (var salutation of ["fle_email_household_salutation", "Salutation", "First Name"]) {
        if ( records.columns.includes(salutation) ) {
          headers.push("user_fle_salutation");
          break;
        }
      }

      for (var extra of ["extra_1", "extra_2", "extra_3"]) {
        if  (records.columns.includes(extra) ) {
          headers.push(extra);
        }
      }

      window.emailHash = {};

      for (var rowNum of Object.keys(records)) {
        var record = records[rowNum];

        for (var column in record) {
          if (column.trim().toLowerCase().endsWith("email")) {
            var email = record[column].trim().toLowerCase();
            if ( !email || ignoredEmails.includes(email) || email.endsWith("example.com") ) { continue; }

            emailHash[email] = emailHash[email] || {}

            for (var salutation of ["fle_email_household_salutation", "Salutation", "First Name"]) {
              if (record[salutation]) {
                emailHash[email]["user_fle_salutation"] = record[salutation];
                break;
              }
            }

            if (window.fullExport) {
              emailHash[email]["user_ngp_ids_with_this_email"] = emailHash[email]["user_ngp_ids_with_this_email"] || [];
              if ( !emailHash[email]["user_ngp_ids_with_this_email"].includes(record["Contact Id"]) ) {
                emailHash[email]["user_ngp_ids_with_this_email"].push(record["Contact Id"]);
              }
            }

            if ( records.columns.includes("Contact Code Ids") ) {
              emailHash[email]["user_ngp_contact_codes"] = emailHash[email]["user_ngp_contact_codes"] || [];

              for (var contactCode of record["Contact Code Ids"].split(",")) {
                if ( ngpContactCodes[contactCode] && !emailHash[email]["user_ngp_contact_codes"].includes(ngpContactCodes[contactCode]) ) {
                  emailHash[email]["user_ngp_contact_codes"].push(ngpContactCodes[contactCode]);
                }
              }
            }

            for (var extra of ["extra_1", "extra_2", "extra_3"]) {
              if ( records.columns.includes(extra) ) {
                emailHash[email][extra] = record[extra];
              }
            }
          }
        }
      }

      window.csvContent = "";
      // csvContent += "data:text/csv;charset=utf-8,";
      csvContent += headers.join(",").split("extra_").join("action_extra_");
      csvContent += "\r\n";

      for (var email in emailHash) {
        var row = [];

        for (var header of headers) {
          var tmp = (header == "email" ? email : emailHash[email][header]);
          if (Array.isArray(tmp)) { tmp = tmp.join(","); }

          row.push('"' + (tmp || "").replace(/"/g, '""') + '"');
        }

        csvContent += row.join(",");
        csvContent += "\r\n";
      }

      // var encodedUri = encodeURI(csvContent);
      var blob = URL.createObjectURL(new Blob([csvContent], {type: "application/octet-stream"}));
      var fileName = document.querySelector('input[name=csv]').files[0].name.split(" ").join("_").toLowerCase().split(".csv").slice(0, -1).join('.csv') + ".normalized.csv";

      d3.select("a#downloadLink")
        .attr("href", blob)
        .attr("download", fileName);

      d3.select("div#downloadDiv")
        .attr("style", "display: block")
    }
  </script>
<!-- End Document
  –––––––––––––––––––––––––––––––––––––––––––––––––– -->
</body>
</html>
